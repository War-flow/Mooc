@page "/"

@using Microsoft.AspNetCore.Identity
@using Mooc.Data
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IDbContextFactory<ApplicationDbContext> DbContextFactory

<PageTitle>Home</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (currentUser != null)
        {
            <h1 class="hello">Bonjour, @currentUser.FirstName</h1>
        }
        else
        {
            <h1 class="hello">Bonjour, @context.User.Identity?.Name</h1>
        }
    </Authorized>
</AuthorizeView>

<CardHome Sessions="@availableSessions" />

@code {
    private ApplicationUser? currentUser;
    private List<Session>? availableSessions;

    protected override async Task OnInitializedAsync()
    {
        // Utilisation de IDbContextFactory pour obtenir une nouvelle instance de DbContext
        using var dbContext = await DbContextFactory.CreateDbContextAsync();
        
        // Récupération des sessions disponibles (pour tous les utilisateurs)
        availableSessions = await dbContext.Sessions
            .Include(s => s.Courses)
            .OrderBy(s => s.StartDate)
            .ToListAsync();
            
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            // Récupération directe depuis le contexte
            var userName = user.Identity.Name;
            currentUser = await dbContext.Users.FirstOrDefaultAsync(u => u.UserName == userName);
        }
    }
}