@using Microsoft.AspNetCore.Components.Forms
@implements IDisposable

<div class="info-block @GetTypeClass()" @attributes="AdditionalAttributes">
    <h4 class="info-title">
        @if (IsEditing)
        {
            <InputText class="form-control" @bind-Value="Block.Title" placeholder="Titre (optionnel)" />
            <ValidationMessage For="@(() => Block.Title)" />
        }
        else if (!string.IsNullOrEmpty(Block.Title))
        {
            @Block.Title
        }
    </h4>

    <div class="info-content">
        @if (IsEditing)
        {
            <InputSelect class="form-select mb-2" @bind-Value="TypedContent.Type">
                <option value="info">Information</option>
                <option value="warning">Attention</option>
                <option value="success">Succès</option>
                <option value="danger">Important</option>
            </InputSelect>

            <InputTextArea class="form-control" @bind-Value="TypedContent.Message" rows="3" placeholder="Contenu du message d'information" />
            <ValidationMessage For="@(() => TypedContent.Message)" />
        }
        else
        {
            <div class="info-message">@TypedContent.Message</div>
        }
    </div>

    <div class="block-controls mt-2">
        <button type="button" class="btn-block btn-valid" @onclick="ToggleEdit" aria-label="@(IsEditing ? "Enregistrer les modifications" : "Modifier le bloc")">
            <i class="bi bi-@(IsEditing ? "floppy" : "pencil")"></i>
            @(IsEditing ? "Enregistrer" : "Modifier")
        </button>
        @if (IsEditing)
        {
            <button type="button" class="btn-block btn-cancel" @onclick="CancelEdit" aria-label="Annuler les modifications">
                <i class="bi bi-x-lg"></i> Annuler
            </button>
        }
        else
        {
            <button type="button" class="btn-block btn-cancel" @onclick="RequestDelete" title="Supprimer ce bloc">
                <i class="bi bi-trash"></i> Supprimer
            </button>
        }
    </div>
</div>

@code {
    [Parameter]
    public CourBuilder.CoursBlock Block { get; set; } = default!;

    [Parameter]
    public EventCallback<CourBuilder.CoursBlock> OnBlockChanged { get; set; }
    
    [Parameter]
    public EventCallback<CourBuilder.CoursBlock> OnDeleteRequested { get; set; }

    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    [CascadingParameter]
    private EditContext? EditContext { get; set; }

    private bool IsEditing { get; set; } = false;
    private InfoBlockContent? _originalContent;
    private string? _originalTitle;

    protected override void OnInitialized()
    {
        // Initialiser le contenu si nécessaire
        if (Block.Content is not InfoBlockContent)
        {
            Block.Content = new InfoBlockContent
            {
                Title = Block.Title ?? string.Empty,
                Message = Block.Message ?? string.Empty,
                Type = "info"
            };
        }
        
        // Synchroniser Block.Message avec TypedContent.Message
        SynchronizeFromContent();
    }

    protected override void OnParametersSet()
    {
        // S'assurer que le contenu est bien initialisé
        if (Block.Content is not InfoBlockContent)
        {
            Block.Content = new InfoBlockContent
            {
                Title = Block.Title ?? string.Empty,
                Message = Block.Message ?? string.Empty,
                Type = "info"
            };
        }
    }

    private void SynchronizeFromContent()
    {
        if (Block.Content is InfoBlockContent content)
        {
            Block.Title = content.Title;
            Block.Message = content.Message;
        }
    }

    private void SynchronizeToContent()
    {
        if (Block.Content is InfoBlockContent content)
        {
            content.Title = Block.Title ?? string.Empty;
            content.Message = Block.Message ?? string.Empty;
        }
    }

    private async Task ToggleEdit()
    {
        if (IsEditing)
        {
            // Sauvegarder les modifications
            SynchronizeFromContent();
            
            // Nettoyer le backup
            _originalContent = null;
            _originalTitle = null;
            
            IsEditing = false;
            
            // Notifier le parent que le bloc a changé
            await OnBlockChanged.InvokeAsync(Block);
        }
        else
        {
            // Créer un backup pour pouvoir annuler
            _originalContent = new InfoBlockContent
            {
                Title = TypedContent.Title,
                Message = TypedContent.Message,
                Type = TypedContent.Type
            };
            _originalTitle = Block.Title;
            
            IsEditing = true;
        }
    }

    private void CancelEdit()
    {
        if (_originalContent != null)
        {
            // Restaurer les valeurs originales
            Block.Content = _originalContent;
            Block.Title = _originalTitle ?? string.Empty;
            SynchronizeFromContent();
        }
        
        IsEditing = false;
    }

    private async Task RequestDelete()
    {
        await OnDeleteRequested.InvokeAsync(Block);
    }

    private string GetTypeClass()
    {
        return TypedContent.Type switch
        {
            "warning" => "alert alert-warning",
            "success" => "alert alert-success",
            "danger" => "alert alert-danger",
            _ => "alert alert-primary"
        };
    }

    // Classe pour contenu spécifique à InfoBlock
    public class InfoBlockContent
    {
        public string Title { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
        public string Type { get; set; } = "info";
    }

    // Propriété de commodité pour accéder au contenu typé
    private InfoBlockContent TypedContent => Block.Content as InfoBlockContent ?? new InfoBlockContent();

    public void Dispose()
    {
        // Nettoyer les ressources si nécessaire
        _originalContent = null;
        _originalTitle = null;
    }
}