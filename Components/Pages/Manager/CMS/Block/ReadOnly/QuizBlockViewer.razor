@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using Mooc.Data
@inject IJSRuntime JSRuntime


<div class="quiz-block-viewer">
    @if (!string.IsNullOrEmpty(Block.Title))
    {
        <h4 class="quiz-title">@Block.Title</h4>
    }

    @if (IsCompleted)
    {
        <div class="alert alert-success">
            <i class="bi bi-check-circle-fill me-2"></i>
            Quiz terminé ! @(IsCorrect.HasValue && IsCorrect.Value ? "Réponse correcte." : "")
        </div>
    }

    @if (!string.IsNullOrEmpty(QuizData.Question))
    {
        <div class="quiz-display">
            <!-- Indicateur de progression -->
            @if (QuizData.ShowProgress)
            {
                <div class="quiz-progress" style="width: @GetProgressPercentage()%"></div>
            }

            <!-- Statistiques du quiz -->
            @if (QuizData.ShowStats && IsCompleted)
            {
                <div class="quiz-stats mb-3">
                    <small class="text-muted">
                        @if (TimeSpent.TotalSeconds > 0)
                        {
                            @($"Temps: {TimeSpent:mm\\:ss}")
                        }
                    </small>
                </div>
            }

            <div class="question mb-4">
                <strong>@((MarkupString)QuizData.Question)</strong>
            </div>

            <div class="options mb-4">
                @for (int i = 0; i < QuizData.Options.Count; i++)
                {
                    var index = i;
                    var optionClass = GetOptionClass(index);

                    <div class="form-check @optionClass @(IsCompleted ? "disabled" : "")"
                         @onclick="() => { if (!IsCompleted) HandleOptionClick(index); }">
                        @if (QuizData.Type == "multiple-select")
                        {
                            <input class="form-check-input" type="checkbox" id="option-@Block.Order-@index"
                                   disabled="@IsCompleted"
                                   checked="@(IsCompleted? CompletedAnswers[index] : UserAnswers[index])"
                                   @onchange="@(e => { if (!IsCompleted) UserAnswers[index] = (bool)e.Value; })" />
                        }
                        else
                        {
                            <input class="form-check-input" type="radio" name="quiz-@Block.Order"
                                   id="option-@Block.Order-@index" value="@index"
                                   disabled="@IsCompleted"
                                   checked="@(IsCompleted? CompletedAnswers[index] : UserAnswers[index])"
                                   @onchange="@(e => { if (!IsCompleted) SetUserAnswer(index); })" />
                        }
                        <label class="form-check-label" for="option-@Block.Order-@index">
                            @QuizData.Options[index].Text

                            <!-- Icônes de résultat avec animation -->
                            @if (IsCompleted && QuizData.Options[index].IsCorrect)
                            {
                                <i class="bi bi-check-circle-fill text-success result-icon"></i>
                            }
                            else if (IsCompleted && CompletedAnswers[index] && !QuizData.Options[index].IsCorrect)
                            {
                                <i class="bi bi-x-circle-fill text-danger result-icon"></i>
                            }
                        </label>
                    </div>
                }
            </div>

            <div class="quiz-actions">
                @if (!IsCompleted)
                {
                    <button type="button" class="btn quiz-submit-btn" @onclick="SubmitAnswer"
                            disabled="@(!HasUserAnswer() || IsSubmitting)">
                        @if (IsSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        <i class="bi bi-check-lg me-2"></i>
                        Valider la réponse
                    </button>

                    <!-- Bouton d'aide (si activé) -->
                    @if (QuizData.AllowHint && !string.IsNullOrEmpty(QuizData.Hint) && !HintUsed)
                    {
                        <button type="button" class="btn btn-outline-info ms-2" @onclick="ShowHint">
                            <i class="bi bi-lightbulb me-1"></i>
                            Indice
                        </button>
                    }
                }
                else
                {
                    <!-- Badge de résultat animé -->
                    @if (IsCorrect.HasValue)
                    {
                        <span class="result-badge @(IsCorrect.Value ? "success" : "error")">
                            @if (IsCorrect.Value)
                            {
                                <i class="bi bi-check-lg me-2"></i>
                                @("Excellent !")
                            }
                            else
                            {
                                <i class="bi bi-x-lg me-2"></i>
                                @("Incorrect")
                            }
                        </span>
                    }
                }
            </div>

            <!-- Indice (si demandé) -->
            @if (HintUsed && !string.IsNullOrEmpty(QuizData.Hint))
            {
                <div class="alert alert-info mt-3">
                    <i class="bi bi-lightbulb me-2"></i>
                    <strong>Indice :</strong> @QuizData.Hint
                </div>
            }

            <!-- Feedback personnalisé -->
            @if (IsCompleted && !IsCorrect.GetValueOrDefault() && QuizData.ShowValidationFeedback && !string.IsNullOrEmpty(ValidationMessage))
            {
                <div class="quiz-feedback">
                    <strong>Feedback :</strong> @ValidationMessage

                    @if (QuizData.ShowCorrectAnswer)
                    {
                        <div class="mt-2">
                            <small><strong>Réponse correcte :</strong> @GetCorrectAnswersText()</small>
                        </div>
                    }
                </div>
            }

            <!-- Explication détaillée -->
            @if (IsCompleted && !string.IsNullOrEmpty(QuizData.Explanation))
            {
                <div class="quiz-explanation">
                    <strong>Explication :</strong> @((MarkupString)QuizData.Explanation)
                </div>
            }

            <!-- Score et statistiques finales -->
            @if (IsCompleted && QuizData.ShowStats)
            {
                <div class="quiz-final-stats mt-3">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="stat-item">
                                <div class="stat-value">@(IsCorrect.GetValueOrDefault() ? "100" : "0")%</div>
                                <div class="stat-label">Score</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-item">
                                <div class="stat-value">@TimeSpent.ToString(@"mm\:ss")</div>
                                <div class="stat-label">Temps</div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Ce quiz n'a pas encore été configuré.
        </div>
    }
</div>

<style>
    .form-check.disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

        .form-check.disabled input,
        .form-check.disabled label {
            cursor: not-allowed;
        }
</style>

@code {
    [Parameter] public CourBuilder.CoursBlock Block { get; set; } = default!;
    [Parameter] public bool IsReadOnly { get; set; } = true;
    [Parameter] public EventCallback<bool> OnQuizCompleted { get; set; }
    [Parameter] public bool IsCompleted { get; set; } = false;
    [Parameter] public EventCallback<bool> IsCompletedChanged { get; set; }

    // Ajout de la déclaration manquante pour QuizData
    private QuizStructure QuizData { get; set; } = new QuizStructure();

    // État du quiz
    private bool IsAnswered { get; set; } = false;
    private bool IsSubmitting { get; set; } = false;
    private bool? IsCorrect { get; set; } = null;
    private List<bool> UserAnswers { get; set; } = new();
    private List<bool> CompletedAnswers { get; set; } = new(); // Pour stocker les réponses après validation
    private string ValidationMessage { get; set; } = string.Empty;
    private DateTime StartTime { get; set; }
    private TimeSpan TimeSpent { get; set; }
    private bool HintUsed { get; set; } = false;

    protected override void OnInitialized()
    {
        LoadQuizData();

        // Si le quiz est déjà complété, on met à jour l'état
        if (IsCompleted)
        {
            IsAnswered = true;
            // Initialiser les réponses complétées avec des valeurs vides
            CompletedAnswers = new List<bool>(new bool[Math.Max(QuizData.Options.Count, 2)]);
        }
        else
        {
            InitializeUserAnswers();
            StartTime = DateTime.UtcNow;
        }
    }

    private void LoadQuizData()
    {
        try
        {
            if (!string.IsNullOrEmpty(Block.Content?.ToString()))
            {
                QuizData = System.Text.Json.JsonSerializer.Deserialize<QuizStructure>(Block.Content.ToString()) ?? new QuizStructure();
            }
        }
        catch
        {
            QuizData = new QuizStructure();
        }
    }

    private void HandleOptionClick(int index)
    {
        if (IsCompleted || IsAnswered) return;

        // Plus de feedback tactile - fonction supprimée
    }

    private async Task SubmitAnswer()
    {
        if (IsCompleted) return; // Empêcher la double soumission

        IsSubmitting = true;
        TimeSpent = DateTime.UtcNow - StartTime;

        // Simulation d'un délai pour l'effet
        await Task.Delay(500);

        // Sauvegarder les réponses de l'utilisateur
        CompletedAnswers = new List<bool>(UserAnswers);

        IsCorrect = CheckAnswer();
        IsAnswered = true;
        IsSubmitting = false;
        IsCompleted = true; // Marquer comme complété

        if (QuizData.ShowValidationFeedback)
        {
            ValidationMessage = IsCorrect.GetValueOrDefault()
                ? GetSuccessMessage()
                : GetFailureMessage();
        }

        // Notifier le parent du changement d'état
        if (IsCompletedChanged.HasDelegate)
        {
            await IsCompletedChanged.InvokeAsync(true);
        }

        // Notification du parent
        if (OnQuizCompleted.HasDelegate)
        {
            await OnQuizCompleted.InvokeAsync(IsCorrect.GetValueOrDefault());
        }

        StateHasChanged();
    }

    private void ShowHint()
    {
        if (IsCompleted) return;
        HintUsed = true;
        StateHasChanged();
    }

    private string GetProgressPercentage()
    {
        if (!IsAnswered && !IsCompleted) return "0";
        return IsCorrect.GetValueOrDefault() ? "100" : "50";
    }

    private string GetSuccessMessage()
    {
        var messages = new[]
        {
            "Excellent travail !",
            "Parfait !",
            "Bravo !",
            "Très bien !",
            "Fantastique !"
        };
        return messages[new Random().Next(messages.Length)];
    }

    private string GetFailureMessage()
    {
        var messages = new[]
        {
            "Pas tout à fait !",
            "Presque !",
            "Ce n'est pas grave, on apprend de ses erreurs.",
        };
        return messages[new Random().Next(messages.Length)];
    }

    private string GetCorrectAnswersText()
    {
        var correctOptions = QuizData.Options
            .Where((option, index) => option.IsCorrect)
            .Select(option => option.Text);
        return string.Join(", ", correctOptions);
    }

    private string GetOptionClass(int index)
    {
        if (!IsCompleted) return string.Empty;

        var classes = new List<string>();

        if (QuizData.Options[index].IsCorrect)
            classes.Add("correct");
        else if (CompletedAnswers[index])
            classes.Add("incorrect");

        return string.Join(" ", classes);
    }

    private void SetUserAnswer(int index)
    {
        if (IsCompleted) return;

        for (int i = 0; i < UserAnswers.Count; i++)
        {
            UserAnswers[i] = (i == index);
        }
    }

    private void InitializeUserAnswers()
    {
        UserAnswers = new List<bool>(new bool[Math.Max(QuizData.Options.Count, 2)]);
    }

    private bool CheckAnswer()
    {
        if (QuizData.Type == "multiple-select")
        {
            for (int i = 0; i < QuizData.Options.Count; i++)
            {
                if (QuizData.Options[i].IsCorrect != UserAnswers[i])
                    return false;
            }
            return true;
        }
        else
        {
            for (int i = 0; i < QuizData.Options.Count; i++)
            {
                if (UserAnswers[i] && QuizData.Options[i].IsCorrect)
                    return true;
            }
            return false;
        }
    }

    private bool HasUserAnswer()
    {
        return UserAnswers != null && UserAnswers.Any(a => a);
    }
}